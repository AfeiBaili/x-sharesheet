<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>文本提取工具</title>
    <link rel="stylesheet" href="./css/text_page.css">
</head>
<body>
<header>
    <h1>文本提取工具</h1>
    <div style="flex:1"></div>
    <button id="btnCopyAll" class="small ghost">复制全部</button>
</header>
<div class="container">
    <main class="panel editor">
        <label>输入文本（支持粘贴 / 手机输入 / 上传后替换）</label>
        <textarea id="source" placeholder="把需要提取的文本粘贴到这里，或在下方按钮中选择并提取..."></textarea>

        <div class="controls">
            <button id="btnUseSelection" class="small">提取选中文本</button>
            <input id="fileInput" type="file" accept="text/*" style="display:none"/>
            <button id="btnLoadFile" class="small">从文件载入</button>
            <button id="sourceDeduplication" class="small">文本去重</button>
            <button id="sourceCurrentLineNumber" class="small ghost">当前行数：0</button>
            <button id="btnClear" class="small">清空</button>
        </div>

        <hr style="border:none;border-top:1px solid #f1f6fb;margin:8px 0"/>

        <label style="margin-top:6px">提取结果</label>
        <div id="output" class="output hidden" contenteditable="true"></div>

        <div class="controls">
            <button id="btnCopyOutput" class="small">复制结果</button>
            <button id="btnShowAndHiddenOutput" class="small">显示结果</button>
            <button id="btnExport" class="small">导出为 TXT</button>
            <button id="outputDeduplication" class="small">结果去重</button>
            <button id="outputCurrentLineNumber" class="small ghost">当前行数：0</button>
            <input id="exportLineNumber" type="number" placeholder="导出行（默认导出全部）">
            <button id="btnClearOutput" class="small">清空结果</button>
        </div>
    </main>

    <aside class="panel sidebar">
        <div>
            <label>分列功能</label>
            <div style="display:grid;gap:6px;margin-top:6px">
                <input id="splitDelimiter" type="text" placeholder="分隔符，例如 , 或 | 或 \\t (制表符)">
                <input id="splitColumns" type="text" placeholder="要取的列号，例如 2 或 1,3 或 2-4">
                <button id="btnSplitColumns" class="small">分列显示</button>
            </div>
        </div>
    </aside>
</div>

<footer class="panel" style="margin:12px">
    使用说明：在左侧粘贴或输入文本 → 新增规则（正则 / 起止）→ 点击规则按钮提取 →
    可复制或导出。页面会把规则保存在浏览器本地（localStorage），便于手机端重复使用。
</footer>

<script src="./js/axios.min.js"></script>
<script>
	// 简单规则管理（保存在 localStorage）
	const source = document.getElementById('source');
	const output = document.getElementById('output');
	const fileInput = document.getElementById('fileInput');
	const sourceCurrentLineNumber = document.getElementById("sourceCurrentLineNumber");
	const outputCurrentLineNumber = document.getElementById("outputCurrentLineNumber");
	const btnExportLineNumber = document.getElementById("exportLineNumber");
	const btnShowAndHiddenOutput = document.getElementById("btnShowAndHiddenOutput");
	const btnOutputDeduplication = document.getElementById("outputDeduplication");
	const btnSourceDeduplication = document.getElementById("sourceDeduplication");

	function deduplication(text) {
		const set = new Set();
		text.split(/\n+/).forEach(line => {
			set.add(line);
		})
		let string = ""
		set.forEach(line => {
			string = string + line + "\n";
		})
		return string.trim();
	}

	btnOutputDeduplication.addEventListener("click", () => {
		output.textContent = deduplication(output.innerText)
		updateLineNumberAll()
	})
	btnSourceDeduplication.addEventListener("click", () => {
		source.value = deduplication(source.value)
		updateLineNumberAll()
	})

	let isHiddenOutput = true
	btnShowAndHiddenOutput.addEventListener("click", () => {
		isHiddenOutput = !isHiddenOutput;
		btnShowAndHiddenOutput.value = isHiddenOutput ? "显示结果" : "隐藏结果";
		if (isHiddenOutput) output.classList.add("hidden");
		else output.classList.remove("hidden");
	})

	function appendOutput(t) {
		output.textContent = ((output.textContent ? output.textContent + '\n' : '') + t).trim();
		output.scrollTop = output.scrollHeight
	}

	// 复制/导出功能
	document.getElementById('btnCopyOutput').addEventListener('click', () => {
		copyText(output.textContent || '');
		alert('已复制提取结果');
	});
	document.getElementById('btnCopyAll').addEventListener('click', () => {
		copyText(source.value || '');
		alert('已复制输入文本');
	});

	function splitLines(text, number) {
		if (text === "") return ""
		const split = text.trim().split("\n");
		const strings = split.splice(0, number);
		output.textContent = split.join("\n")
		updateLineNumber(sourceCurrentLineNumber)
		updateLineNumber(outputCurrentLineNumber)
		return strings.join("\n");
	}

	document.getElementById('btnExport').addEventListener('click', () => {
		let str;
		if (btnExportLineNumber.value === "") {
			str = output.textContent
		} else {
			str = splitLines(output.textContent, btnExportLineNumber.value);
		}

		const blob = new Blob([str || ''], {type: 'text/plain;charset=utf-8'});
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = 'extract.txt';
		document.body.appendChild(a);
		a.click();
		a.remove();
		URL.revokeObjectURL(url);
	});

	function copyText(t) {
		navigator.clipboard?.writeText(t).catch(() => { // fallback
			const ta = document.createElement('textarea');
			ta.value = t;
			document.body.appendChild(ta);
			ta.select();
			document.execCommand('copy');
			ta.remove();
		})
	}

	document.getElementById('btnClear').addEventListener('click', () => {
		source.value = ''
		updateLineNumber(sourceCurrentLineNumber)
	});
	document.getElementById('btnClearOutput').addEventListener('click', () => {
		output.textContent = ''
		updateLineNumber(outputCurrentLineNumber)
	});

	// 选中文本提取（textarea 特殊处理）
	document.getElementById('btnUseSelection').addEventListener('click', () => {
		const ta = source;
		const s = ta.value.substring(ta.selectionStart, ta.selectionEnd);
		if (!s) return alert('请先选中要提取的部分（在输入框内选中）');
		appendOutput('--- 选中内容 ---\n' + s + '\n');
		updateLineNumberAll()
	});

	// 从文件载入
	document.getElementById('btnLoadFile').addEventListener('click', () => fileInput.click());
	fileInput.addEventListener('change', (e) => {
		const f = e.target.files[0];
		if (!f) return;
		const reader = new FileReader();
		reader.onload = () => {
			source.value = source.value + reader.result;
			updateLineNumberAll()
		};
		reader.readAsText(f);
		e.target.value = ""
	});

	source.oninput = e => {
		updateLineNumber(sourceCurrentLineNumber);
	}
	output.oninput = e => {
		updateLineNumber(outputCurrentLineNumber);
	}

	function updateLineNumberAll() {
		updateLineNumber(sourceCurrentLineNumber)
		updateLineNumber(outputCurrentLineNumber)
	}

	function updateLineNumber(element) {
		let number;
		if (element === sourceCurrentLineNumber) {
			number = source.value.trim().split('\n').length;
		} else if (element === outputCurrentLineNumber) {
			number = output.innerText.trim().split('\n').length;
		}
		element.innerText = `当前行数：${number}`
	}

	// 分列功能（支持选择具体列）
	document.getElementById("btnSplitColumns").addEventListener("click", () => {
		const delimiterInput = document.getElementById("splitDelimiter").value.trim();
		const columnsInput = document.getElementById("splitColumns").value.trim();

		if (!delimiterInput) {
			alert("请输入分隔符，例如 , | 或 \\t（制表符）");
			return;
		}

		const delimiter = delimiterInput === "\\t" ? "\t" : delimiterInput;
		const text = source.value.trim();
		if (!text) {
			alert("请先执行提取或确保输入框中有内容");
			return;
		}

		// 解析列号输入
		let selectedColumns = [];
		if (columnsInput) {
			const parts = columnsInput.split(",");
			for (let p of parts) {
				p = p.trim();
				if (p.includes("-")) {
					const [start, end] = p.split("-").map(x => parseInt(x.trim()));
					if (!isNaN(start) && !isNaN(end)) {
						for (let i = start; i <= end; i++) selectedColumns.push(i);
					}
				} else {
					const num = parseInt(p);
					if (!isNaN(num)) selectedColumns.push(num);
				}
			}
			selectedColumns = [...new Set(selectedColumns)].sort((a, b) => a - b);
		}

		const lines = text.split(/\r?\n/);
		const formatted = lines.map(line => {
			const cols = line.split(delimiter).map(c => c.trim());
			if (selectedColumns.length === 0) {
				return cols.join("\t\t");
			} else {
				const selected = selectedColumns
					.filter(i => i > 0 && i <= cols.length)
					.map(i => cols[i - 1]);
				return selected.join("\t\t");
			}
		}).join("\n");

		const label = selectedColumns.length
			? `第 ${selectedColumns.join(", ")} 列`
			: "全部列";

		appendOutput(`${formatted}`);
		updateLineNumber(sourceCurrentLineNumber)
		updateLineNumber(outputCurrentLineNumber)
	});

</script>
<script src="./js/pako.min.js"></script>
<script>
	class Message {
		constructor(uuid, name, messageObj) {
			this.uuid = uuid
			this.name = name
			this.message = JSON.stringify(messageObj)
		}
	}

	class Status {
		constructor(code) {
			this.code = code;
		}

		setData(data = "*-/@!$$@@#ax231clear@!23a1s31dd@!#") {
			this.data = data;
			return this;
		}
	}

	const CLEAR_HISTORY = new Status(9);
	const SOURCE_TEXT = new Status(1);
	const OUTPUT_TEXT = new Status(2);

	let uuid
	let socket
	axios.get("https://sheet.yfose.cn:8080/channel/get?name=text-extraction").then(res => {
		// axios.get("http://127.0.0.1:8080/channel/get?name=text-extraction").then(res => {
		uuid = res.data
		socket = new WebSocket("wss://sheet.yfose.cn:8080");
		// socket = new WebSocket("ws://127.0.0.1:8080");
		socket.binaryType = "arraybuffer"
		socket.onopen = () => {
			sendBinaryMessage("/init")
		}
		socket.onmessage = (event) => {
			const array = new Uint8Array(event.data);
			const messageObj = JSON.parse(pako.ungzip(array, {to: "string"}));
			if (messageObj === "/init") {
				// console.log("/init")
			} else {
				const code = messageObj.code;
				if (code === 1) {
					source.value = messageObj.data;
				} else if (code === 2) {
					output.textContent = messageObj.data;
				}
				updateLineNumber(sourceCurrentLineNumber)
				updateLineNumber(outputCurrentLineNumber)
			}
		}
	})

	function sendBinaryMessage(obj) {
		let message = pako.gzip(JSON.stringify(new Message(uuid, "text-extraction", obj)))
		socket.send(message)
	}

	window.addEventListener("beforeunload", function (event) {
		if (source.value !== "" || output.innerText !== "") {
			sendBinaryMessage(CLEAR_HISTORY.setData())
			sendBinaryMessage(SOURCE_TEXT.setData(source.value))
			sendBinaryMessage(OUTPUT_TEXT.setData(output.innerText))
		}
		event.preventDefault();
	});
</script>
</body>
</html>
